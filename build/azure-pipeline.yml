# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main
- preview
- master

name: $(GITVERSION_SemVer)

variables:
  isMain: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]
  environmentName: 'AzureDevOpsMigrationTools-Dev'
  environmentTag: 'Dev'
  isRelease: false
  isPreview: false
  shouldDeploy: false
  skipCompileTest: true

# Versioning of repo

stages:
- stage: Versioning
  displayName: 'Versioning'
  jobs: 
  - job: VersionJob
    displayName: 'Version job'
    pool:
      vmImage: 'windows-latest'
    variables:
      Agent.Source.Git.ShallowFetchDepth: 0
    steps:
    - task: gitversion/setup@1
      inputs:
        versionSpec: '5.x'
    - task: gitversion/execute@1
      displayName: 'GitVersion'
      name: GitVersion
      inputs:
        updateAssemblyInfo: true
    - task: PowerShell@2
      displayName: Set Environment Variables
      inputs:
        targetType: 'inline'
        script: |
          if ("$(GitVersion.PreReleaseTag)" -eq "")
          {
            Write-Host "##vso[task.setvariable variable=environmentName;]AzureDevOpsMigrationTools-Release"
            Write-Host "##vso[task.setvariable variable=environmentTag;]Release"
            Write-Host "##vso[task.setvariable variable=isRelease;]true"
            Write-Host "##vso[task.setvariable variable=isPreview;]false"
            Write-Host "##vso[task.setvariable variable=shouldDeploy;]true"
          }
          if ("$(GitVersion.PreReleaseLabel)" -contains "Preview")
          {
            Write-Host "##vso[task.setvariable variable=environmentName;]AzureDevOpsMigrationTools-Preview"
            Write-Host "##vso[task.setvariable variable=environmentTag;]Preview"
            Write-Host "##vso[task.setvariable variable=isRelease;]false"
            Write-Host "##vso[task.setvariable variable=isPreview;]true"
            Write-Host "##vso[task.setvariable variable=shouldDeploy;]true"
          }

          Write-Host "GITVERSION.SemVer: $(GITVERSION.PreReleaseLabel)"
          Write-Host "GITVERSION.SemVer: $(GITVERSION.SemVer)"
          Write-Host "GitVersion.SemVer: $(GitVersion.SemVer)"
          Write-Host "GitVersion.AssemblySemVer: $(GitVersion.AssemblySemVer)"
          Write-Host "GitVersion.InformationalVersion: $(GitVersion.InformationalVersion)"

# Build, Test and Package

- stage: Build
  displayName: 'Build Test & Package'
  dependsOn: Versioning
  jobs: 
  - job: BuildJob
    displayName: 'Build job'
    condition:  and(succeeded(), eq(variables['skipCompileTest'], 'false'))
    pool:
      vmImage: 'windows-latest'
      demands:
      - npm
    variables:
      solution: '**/*.sln'
      buildPlatform: 'Any CPU'
      buildConfiguration: 'Release'
      GitVersion.SemVer: $[ stageDependencies.Versioning.VersionJob.outputs['GitVersion.SemVer'] ]
      GitVersion.AssemblySemVer: $[ stageDependencies.Versioning.VersionJob.outputs['GitVersion.AssemblySemVer'] ]
      GitVersion.InformationalVersion: $[ stageDependencies.Versioning.VersionJob.outputs['GitVersion.InformationalVersion'] ]
    steps:
    - task: SonarCloudPrepare@2
      inputs:
        SonarCloud: 'Martins Sonar Cloud'
        organization: 'nkdagility'
        scannerMode: 'MSBuild'
        projectKey: 'vsts-sync-migrator:master'
        projectName: 'azure-devops-migration-tools'
        projectVersion: '$(GitVersion.SemVer)'

    - task: DotNetCoreCLI@2
      displayName: "Restore"
      inputs:
        command: 'restore'
        feedsToUse: 'select'
    - task: DotNetCoreCLI@2
      displayName: "Complie"
      inputs:
        command: 'build'
        arguments: '/p:Version=$(GitVersion.AssemblySemVer) /p:FileVersion=$(GitVersion.AssemblySemVer) /p:InformationalVersion=$(GetVersion.InformationalVersion)'
    - task: DotNetCoreCLI@2
      displayName: "Test L0 & L1"
      inputs:
        command: 'test'
        arguments: '--collect "Code coverage" --no-build --filter "(TestCategory=L0|TestCategory=L1)" --logger trx'
      continueOnError: true
    - task: DotNetCoreCLI@2
      displayName: "Test L2 & L3"
      inputs:
        command: 'test'
        arguments: '--collect "Code coverage" --no-build --filter "(TestCategory=L2|TestCategory=L3)" --logger trx'
      continueOnError: true
    - task: DotNetCoreCLI@2
      displayName: "Test (other)"
      inputs:
        command: 'test'
        arguments: '--collect "Code coverage" --no-build --filter "(TestCategory!=L0&TestCategory!=L1&TestCategory!=L2&TestCategory!=L3)" --logger trx'
      continueOnError: true

    - task: SonarCloudAnalyze@2
      inputs:
        jdkversion: 'JAVA_HOME_17_X64'
      continueOnError: true

    - task: PublishSymbols@2
      inputs:
        SearchPattern: '**/bin/**/*.pdb'
        SymbolServerType: TeamServices
      continueOnError: true

    - task: PowerShell@2
      displayName: "Packaging (Executable)"
      inputs:
        filePath: '.\build\packageExecutable.ps1'
        arguments: '-version $(GitVersion.SemVer) -outfolder "$(Build.ArtifactStagingDirectory)"' 
    - task: PowerShell@2
      displayName: "Packaging (Extension)"
      inputs:
        filePath: '.\build\packageExtension.ps1'
        arguments: '-version $(GitVersion.SemVer) -outfolder "$(Build.ArtifactStagingDirectory)"' 
    - task: PowerShell@2
      displayName: "Packaging (Chocolatey)"
      inputs:
        filePath: '.\build\packageChocolatey.ps1'
        arguments: '-version $(GitVersion.SemVer) -outfolder "$(Build.ArtifactStagingDirectory)"' 
    - task: PowerShell@2
      displayName: "Packaging (Nuget)"
      inputs:
        filePath: '.\build\packageNuget.ps1'
        arguments: '-version $(GitVersion.SemVer) -outfolder "$(Build.ArtifactStagingDirectory)"' 
    - task: PowerShell@2
      displayName: "Packaging (Winget)"
      inputs:
        filePath: '.\build\packageWinget.ps1'
        arguments: '-version $(GitVersion.SemVer) -outfolder "$(Build.ArtifactStagingDirectory)"' 

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'

    - task: SonarCloudPublish@2
      inputs:
        pollingTimeoutSec: '300'

  - job: "BuildSimulationJob"
    displayName: 'Build djob'
    condition:  and(succeeded(), eq(variables['skipCompileTest'], 'true'))
    pool:
      vmImage: 'windows-latest'
      demands:
      - npm
    variables:
      solution: '**/*.sln'
      buildPlatform: 'Any CPU'
      buildConfiguration: 'Release'
      GitVersion.SemVer: $[ stageDependencies.Versioning.VersionJob.outputs['GitVersion.SemVer'] ]
      GitVersion.AssemblySemVer: $[ stageDependencies.Versioning.VersionJob.outputs['GitVersion.AssemblySemVer'] ]
      GitVersion.InformationalVersion: $[ stageDependencies.Versioning.VersionJob.outputs['GitVersion.InformationalVersion'] ]
    steps:
      - task: PowerShell@2
        displayName: Read Environment Variables
        continueOnError: true
        inputs:
          targetType: 'inline'
          script: |
            Write-Host "Run Simulation Build"
            New-Item -Path $(Build.ArtifactStagingDirectory) -Name "MigrationTools-$(GitVersion.SemVer).zip" -ItemType "file" -Force
            New-Item -Path $(Build.ArtifactStagingDirectory) -Name "nkdAgility.vsts-sync-migration-$(GitVersion.SemVer).vsix" -ItemType "file" -Force
            New-Item -Path $(Build.ArtifactStagingDirectory) -Name "MigrationTools.15.0.5.nupkg" -ItemType "file" -Force
            New-Item -Path $(Build.ArtifactStagingDirectory) -Name "MigrationTools-$(GitVersion.SemVer).zip" -ItemType "file" -Force
      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)'
          ArtifactName: 'drop'
          publishLocation: 'Container'

# Release to GitHub Releases

- stage: ReleaseGitHub
  displayName: 'Release to GitHub Releases'
  dependsOn: Build
  condition:  or(succeeded(), eq(variables['skipCompileTest'], 'true'))
  # condition:  and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['Build.SourceBranch'], 'refs/heads/master'), eq(variables['Build.SourceBranch'], 'refs/heads/preview'))
  jobs:
  - deployment: GitHubRelease
    environment: $(environmentName)
    pool:
      vmImage: 'windows-latest'
    variables:
      SemVer: $[ stageDependencies.Versioning.VersionJob.outputs['GitVersion.SemVer'] ]
      PreReleaseTag: $[ stageDependencies.Versioning.VersionJob.outputs['GitVersion.PreReleaseTag'] ]
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            condition: and(succeeded(), eq(variables['doCompileTest'], 'true'))
            artifact: drop
          - task: PowerShell@2
            displayName: Read Environment Variables
            continueOnError: true
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "environmentName: $(GenvironmentName)"
                Write-Host "environmentTag: $(environmentTag)"
                Write-Host "isRelease: $(isRelease)"
                Write-Host "isPreview: $(isPreview)"
                Write-Host "shouldDeploy: $(shouldDeploy)"
                Write-Host "SemVer: $(SemVer)"
                Write-Host "PreReleaseTag: $(PreReleaseTag)"                

# Release to Azure DevOps Extension Marketplace

- stage: ReleaseExtension
  displayName: 'Release to Azure DevOps Extension Marketplace'
  dependsOn: ReleaseGitHub
  condition:  or(succeeded(), eq(variables['skipCompileTest'], 'true'))
  # condition:  and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['Build.SourceBranch'], 'refs/heads/master'), eq(variables['Build.SourceBranch'], 'refs/heads/preview'))
  jobs:
  - deployment: tfxcliRelease
    environment: $(environmentName)
    pool:
      vmImage: 'windows-latest'
    variables:
      SemVer: $[ stageDependencies.Versioning.VersionJob.outputs['GitVersion.SemVer'] ]
      PreReleaseTag: $[ stageDependencies.Versioning.VersionJob.outputs['GitVersion.PreReleaseTag'] ]
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            condition: and(succeeded(), eq(variables['doCompileTest'], 'true'))
            artifact: drop
          - task: PowerShell@2
            displayName: Read Environment Variables
            continueOnError: true
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "environmentName: $(GenvironmentName)"
                Write-Host "environmentTag: $(environmentTag)"
                Write-Host "isRelease: $(isRelease)"
                Write-Host "isPreview: $(isPreview)"
                Write-Host "shouldDeploy: $(shouldDeploy)"
                Write-Host "SemVer: $(SemVer)"
                Write-Host "PreReleaseTag: $(PreReleaseTag)"  

# Release to Chocolatey Community Repository

- stage: ReleaseChocolatey
  displayName: 'Release to Chocolatey Community Repository'
  dependsOn: ReleaseGitHub
  condition:  or(succeeded(), eq(variables['skipCompileTest'], 'true'))
  # condition:  and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['Build.SourceBranch'], 'refs/heads/master'), eq(variables['Build.SourceBranch'], 'refs/heads/preview'))
  jobs:
  - deployment: ChocoRelease
    environment: $(environmentName)
    pool:
      vmImage: 'windows-latest'
    variables:
      SemVer: $[ stageDependencies.Versioning.VersionJob.outputs['GitVersion.SemVer'] ]
      PreReleaseTag: $[ stageDependencies.Versioning.VersionJob.outputs['GitVersion.PreReleaseTag'] ]
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            condition: and(succeeded(), eq(variables['doCompileTest'], 'true'))
            artifact: drop
          - task: PowerShell@2
            displayName: Read Environment Variables
            continueOnError: true
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "environmentName: $(GenvironmentName)"
                Write-Host "environmentTag: $(environmentTag)"
                Write-Host "isRelease: $(isRelease)"
                Write-Host "isPreview: $(isPreview)"
                Write-Host "shouldDeploy: $(shouldDeploy)"
                Write-Host "SemVer: $(SemVer)"
                Write-Host "PreReleaseTag: $(PreReleaseTag)"  

# Release to Winget package Repository

- stage: ReleaseWinget
  displayName: 'Release to Winget package Repository'
  dependsOn: ReleaseGitHub
  condition: or(succeeded(), eq(variables['skipCompileTest'], 'true'))
  # condition:  and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['Build.SourceBranch'], 'refs/heads/master'), eq(variables['Build.SourceBranch'], 'refs/heads/preview'))
  jobs:
  - deployment: WingetRelease
    environment: $(environmentName)
    pool:
      vmImage: 'windows-latest'
    variables:
      SemVer: $[ stageDependencies.Versioning.VersionJob.outputs['GitVersion.SemVer'] ]
      PreReleaseTag: $[ stageDependencies.Versioning.VersionJob.outputs['GitVersion.PreReleaseTag'] ]
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            condition: and(succeeded(), eq(variables['doCompileTest'], 'true'))
            artifact: drop
          - task: PowerShell@2
            displayName: Read Environment Variables
            continueOnError: true
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "environmentName: $(GenvironmentName)"
                Write-Host "environmentTag: $(environmentTag)"
                Write-Host "isRelease: $(isRelease)"
                Write-Host "isPreview: $(isPreview)"
                Write-Host "shouldDeploy: $(shouldDeploy)"
                Write-Host "SemVer: $(SemVer)"
                Write-Host "PreReleaseTag: $(PreReleaseTag)"  